# 运算符

## 优先级和结合性

优先级：优先级决定表达式中多个运算符的运算顺序，优先级越高，越早执行

结合性：当一个表达式中有相同优先级的运算符时，需要使用结合性来判断哪个运算符先执行

- 左结合性：最左边的运算符先执行，从左往右依次执行
- 右结合性：最右边的运算符先执行，从右往左依次执行

下表中，每个运算符的优先级都高于它后面的行中的运算符（优先级从上到下排序，越往上优先级越高）

| 描述           | 运算符                                                  | 结合性           |
| -------------- | ------------------------------------------------------- | ---------------- |
| 一元后缀       | `expr++`  `expr--`  `()`  `[]`  `?[]`  `.`  `?.`  `!`   | None             |
| 一元前缀       | `-expr` `!expr` `~expr` `++expr` `--expr` `await exprt` | None             |
| 乘法           | `*` `/` `%` `~/`                                        | 左结合，自左向右 |
| 加法           | `+` `-`                                                 | 左结合，自左向右 |
| 移位           | `<<` `>>` `>>>`                                         | 左结合，自左向右 |
| 按位与         | `&`                                                     | 左结合，自左向右 |
| 按位异或       | `^`                                                     | 左结合，自左向右 |
| 按位或         | `|`                                                     | 左结合，自左向右 |
| 关系与类型测试 | `>=` `>` `<=` `<` `as` `is` `is!`                       | None             |
| 相等           | `==` `!=`                                               | None             |
| 逻辑与         | `&&`                                                    | 左结合，自左向右 |
| 逻辑或         | `||`                                                    | 左结合，自左向右 |
| if null        | `??`                                                    | 左结合，自左向右 |
| 条件           | `condition ? expr1 : expr2`                             | 右结合，自右向左 |
| 级联           | `..` `?..`                                              | 左结合，自左向右 |
| 赋值           | `=` `*=` `/=` `+=` `-=` `&=` `^=` 等等                  | 右结合，自右向左 |





## 算数运算符

Dart 支持常用的算数运算符：

| 运算符  | 含义                               | 结合性           |
| ------- | ---------------------------------- | ---------------- |
| `+`     | 加法                               | 左结合，自左向右 |
| `-`     | 减法                               | 左结合，自左向右 |
| `-expr` | 一元减号，负数（否定，反转表达式） | None             |
| `*`     | 乘法                               | 左结合，自左向右 |
| `/`     | 除法                               | 左结合，自左向右 |
| `~/`    | 除法，返回整数结果                 | 左结合，自左向右 |
| `%`     | 取模，获取整数除法的余数           | 左结合，自左向右 |

```dart
assert(2 + 3 == 5);
assert(2 - 3 ==  -1);
assert(2 * 3 == 6);
assert(5 / 2 == 2.5);
assert(5 ~/ 2 == 2);
assert(5 % 2 == 1);

assert('5/2 = ${5 ~/ 2} r ${5 % 2}' == '5/2 = 2 r 1');
```

递增/递减运算符

| 运算符  | 含义                                     | 结合性 |
| ------- | ---------------------------------------- | ------ |
| `++var` | `var = var + 1`（表达式的值是`var + 1`） | None   |
| `var++` | `var = var + 1`（表达是的值是`var`）     | None   |
| `--var` | `var = var - 1`（表达式的值是`var - 1`） | None   |
| `var--` | `var = var - 1`（表达式的值是`var`）     | None   |

```dart
int a;
int b;

a = 0;
b = ++a; // 先递增，再返回递增之后的值，所以 b == 1
assert(b == a); // 1 == 1

a = 0;
b = a++; // 先返回值，再递增，所以 b == 0;
assert(b != a); // 0 != 1

a = 0;
b = --a; // 先递减，再返回递减之后的值，所以 b == -1
assert(b == a); // -1 == -1

a = 0;
b = a--; // 先返回值，再递减，所以 b == 0;
assert(b != a); // 0 != -1
```

## 关系运算符

| 运算符 | 含义     | 结合性 |
| ------ | -------- | ------ |
| `==`   | 相等     | None   |
| `!=`   | 不相等   | None   |
| `>`    | 大于     | None   |
| `<`    | 小于     | None   |
| `>=`   | 大于等于 | None   |
| `<=`   | 小于等于 | None   |

`==`运算符的工作原理：

- 如果`x`或`y`为`null`，当两者都为`null`时，返回`true`，否则返回`false`；
- 返回以参数`y`对`x`调用`==`方法的结果（`==`等运算符是在其第一个操作数上调用的方法）。

```dart
assert(2 == 2);
assert(2 != 3);
assert(3 > 2);
assert(2 < 3);
assert(3 >= 3);
assert(2 <= 3);
```

## 类型测试运算符

在运行时检查类型

| 操作符 | 含义                           | 结合性 |
| ------ | ------------------------------ | ------ |
| `as`   | 类型转换（也用于指定库前缀）   | None   |
| `is`   | 如果对象具有指定类型则为`true` | None   |
| `is!`  | 如果对象没有指定类型则为`true` | None   |

```dart
(employee as Person).firstName = 'Bob';

if (employee is Person) {
  employee.firstName = 'Bob';
}
```

## 赋值运算符

使用`=`给变量赋值，如果仅在变量为`null`时赋值，使用`??=`运算符。

复合赋值运算符：将运算和赋值组合在一起

复合赋值运算符工作原理：

|                  | 符合运算符 | 等价于       |
| ---------------- | ---------- | ------------ |
| 对于操作符：`op` | `a op= b`  | `a = a op b` |
| 例如：           | `a += b`   | `a = a + b`  |

```dart
var a = 2;
a *= 3;
assert(a == 6);
```

## 逻辑运算符

| 运算符  | 含义                                      | 结合性           |
| ------- | ----------------------------------------- | ---------------- |
| `!expr` | 反转表达式（`false`改为`true`，反之亦然） | None             |
| `||`    | 或                                        | 左结合，自左向右 |
| `&&`    | 与                                        | 左结合，自左向右 |

```dart
if (!done && (col == 0 || col == 3)) {
  // ...do something...
}
```

## 按位运算符和移位运算符

| 运算符 | 含义                                                         | 结合性           |
| ------ | ------------------------------------------------------------ | ---------------- |
| `&`    | 按位与（`AND`）                                              | 左结合，自左向右 |
| `|`    | 按位或（`OR`）                                               | 左结合，自左向右 |
| `^`    | 按位异或（`XOR`，如果两个二进制数的相同位上都是`0`或`1`，则该位的结果为`0`，否则为`1`） | 左结合，自左向右 |
| `~`    | 按位非（一元按位补码，`0`变`1`，`1`变`0`                     | None             |
| `<<`   | 左移                                                         | 左结合，自左向右 |
| `>>`   | 右移，将一个操作数按指定移动的位数向右移动，右边移出位被丢弃，左边移出的空位补`符号位` | 左结合，自左向右 |
| `>>>`  | 无符号右移，将一个操作数按指定移动的位数向右移动，右边移出位被丢弃，左边移出的空位补`0` | 左结合，自左向右 |

```dart
// 以64位整数为例，dart默认创建64位整数
var value = 0x22;   // 0000 0000 0000 0000 0000 0000 0000 0000 0000 0000 0000 0000 0000 0000 0010 0010
var bitmask = 0x0f; // 0000 0000 0000 0000 0000 0000 0000 0000 0000 0000 0000 0000 0000 0000 0000 1111

// 与
// 0000 0000 0000 0000 0000 0000 0000 0000 0000 0000 0000 0000 0000 0000 0010 0010
// 0000 0000 0000 0000 0000 0000 0000 0000 0000 0000 0000 0000 0000 0000 0000 1111
// 0000 0000 0000 0000 0000 0000 0000 0000 0000 0000 0000 0000 0000 0000 0000 0010
assert((value & bitmask) == 0x02);

// 与，非
// 0000 0000 0000 0000 0000 0000 0000 0000 0000 0000 0000 0000 0000 0000 0010 0010
// 1111 1111 1111 1111 1111 1111 1111 1111 1111 1111 1111 1111 1111 1111 1111 0000
// 0000 0000 0000 0000 0000 0000 0000 0000 0000 0000 0000 0000 0000 0000 0020 0000
assert((value & ~bitmask) == 0x20);

// 或
// 0000 0000 0000 0000 0000 0000 0000 0000 0000 0000 0000 0000 0000 0000 0010 0010
// 0000 0000 0000 0000 0000 0000 0000 0000 0000 0000 0000 0000 0000 0000 0000 1111
// 0000 0000 0000 0000 0000 0000 0000 0000 0000 0000 0000 0000 0000 0000 0010 1111
assert((value | bitmask) == 0x2f);

// 异或
// 0000 0000 0000 0000 0000 0000 0000 0000 0000 0000 0000 0000 0000 0000 0010 0010
// 0000 0000 0000 0000 0000 0000 0000 0000 0000 0000 0000 0000 0000 0000 0000 1111
// 0000 0000 0000 0000 0000 0000 0000 0000 0000 0000 0000 0000 0000 0000 0010 1101
assert((value ^ bitmask) == 0x2d);

// 左移
// 0000 0000 0000 0000 0000 0000 0000 0000 0000 0000 0000 0000 0000 0000 0010 0010
// 0000 0000 0000 0000 0000 0000 0000 0000 0000 0000 0000 0000 0000 0010 0010 0000
assert((valeu << 4) == 0x220);

// 右移
// 0000 0000 0000 0000 0000 0000 0000 0000 0000 0000 0000 0000 0000 0000 0010 0010
// 0000 0000 0000 0000 0000 0000 0000 0000 0000 0000 0000 0000 0000 0000 0000 0010
assert((value >> 4) == 0x02);

// 无符号右移
// 0000 0000 0000 0000 0000 0000 0000 0000 0000 0000 0000 0000 0000 0000 0010 0010
// 0000 0000 0000 0000 0000 0000 0000 0000 0000 0000 0000 0000 0000 0000 0000 0010
assert((value >>> 4) == 0x02);

// 负数右移
// 原码：1000 0000 0000 0000 0000 0000 0000 0000 0000 0000 0000 0000 0000 0000 0010 0010
// 反码：1111 1111 1111 1111 1111 1111 1111 1111 1111 1111 1111 1111 1111 1111 1101 1101
// 补码：1111 1111 1111 1111 1111 1111 1111 1111 1111 1111 1111 1111 1111 1111 1101 1110
// 右移：1111 1111 1111 1111 1111 1111 1111 1111 1111 1111 1111 1111 1111 1111 1111 1101 高位补1，负数，要还原成原码
// 反码：1111 1111 1111 1111 1111 1111 1111 1111 1111 1111 1111 1111 1111 1111 1111 1100
// 原码：1000 0000 0000 0000 0000 0000 0000 0000 0000 0000 0000 0000 0000 0000 0000 0011
assert((-value >> 4) == -0x03);

// 负数无符号右移
// 原码：1000 0000 0000 0000 0000 0000 0000 0000 0000 0000 0000 0000 0000 0000 0010 0010
// 反码：1111 1111 1111 1111 1111 1111 1111 1111 1111 1111 1111 1111 1111 1111 1101 1101
// 补码：1111 1111 1111 1111 1111 1111 1111 1111 1111 1111 1111 1111 1111 1111 1101 1110
// 右移：0000 1111 1111 1111 1111 1111 1111 1111 1111 1111 1111 1111 1111 1111 1111 1101 正数，补码和原码一样
assert((-value >>> 4) == 0x0ffffffffffffffd);

```

## 条件表达式

- `condition ? expr1 : expr2`：如果`condition`为`true`，执行并返回`expr1`的值，否则执行并返回`expr2`的值；
- `expr1 ?? expr2`：如果`expr1`不为`null`，返回`expr1`的值，否则执行并返回`expr2`的值。

```dart
var visiblity = isPublic ? 'public' : 'private';

String playerName(String? name) => name ?? 'Guest';
// 等价于
String playerName(String? name) => name != null ? name : 'Guest';
// 等价于
String playerName(String? name) {
  if (name != null) {
    return name;
  } else {
    return 'Guest';
  }
}
```

## 级联

级联（`..`，`?..`）允许对同一对象进行一系列操作，并返回该对象，级联操作符节省了创建临时变量的步骤

```dart
var paint = new Paint()
  ..color = Colors.black
  ..strokeCap = StrokeCap.round
  ..strokeWidth = 5.0;
// 等价于
var paint = new Paint();
paint.color = Colors.black;
paint.strokeCap = StrokeCap.round;
paint.strokeWidth = 5.0;

// 如果级联操作的对象可能为`null`时：
querySelector('#confirm') // Get an object.
  ?..text = 'Confirm' // Use its members.
  ..classes.add('important')
  ..onClick.listen((e) => window.alert('Confirmed!'))
  ..scrollIntoView();
// 等价于
var button = querySelector('#confirm');
button?.text = 'Confirm';
button?.classes.add('important');
button?.onClick.listen((e) => window.alert('Confirmed!'));
button?.scrollIntoView();

// 嵌套级联
final addressBook = (AddressBookBuilder()
        ..name = 'jenny'
        ..email = 'jenny@example.com'	
        ..phone = (PhoneNumberBuilder()
              ..number = '415-555-0100'
              ..label = 'home')
            .build())
      .build();
```

## 其他操作符

| 操作符 | 名称                                         | 含义                                                         | 例子          |
| ------ | -------------------------------------------- | ------------------------------------------------------------ | ------------- |
| `()`   | 函数应用（Function application）             | 表示函数调用                                                 |               |
| `[]`   | 下标访问（Subscript access）                 | 表示对可重写`[]`运算符的调用                                 | `fooList[1]`  |
| `?[]`  | 条件下标访问（Conditional subscript access） | 类似`[]`，但是最左边的操作数可以为`null`                     | `fooList?[1]` |
| `.`    | 成员访问（Member access）                    | 引用表达式的属性                                             | `foo.bar`     |
| `?.`   | 条件成员访问（Conditional member access）    | 类似`.`，但是最左边的操作数可以为`null`                      | `foo?.bar`    |
| `!`    | 空断言运算符                                 | 将表达式转换为其基础的不可空类型，如果转换失败则抛出运行时异常 | `foo!.bar`    |







